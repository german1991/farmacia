<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Alta Cliente - Farmacia</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Estilos mínimos para que se vea bien */
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:16px;background:#f7f7f8}
    .container{max-width:980px;margin:0 auto}
    .card{background:white;border-radius:8px;padding:16px;margin-bottom:16px;box-shadow:0 1px 4px rgba(0,0,0,0.06)}
    h3{margin:0 0 12px 0}
    .form-row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:8px}
    .form-row label.small{width:120px;align-self:center}
    .input, textarea, select {flex:1;padding:8px;border-radius:6px;border:1px solid #ddd;min-width:180px}
    textarea{min-height:68px}
    .btn{background:#1976d2;color:white;border:none;padding:8px 12px;border-radius:6px;cursor:pointer}
    .btn.ghost{background:transparent;border:1px solid #ccc;color:#333}
    .btn.danger{background:#d32f2f}
    .small{font-size:13px;color:#666}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:8px;border-bottom:1px solid #eee;text-align:left}
    th{background:#fafafa}
    .actions button{margin-right:6px}
    .nav{display:flex;gap:20px;margin-bottom:20px}
    .nav details summary{cursor:pointer;font-weight:bold}
    .search-row{display:flex;gap:8px;align-items:center}
    .note{font-size:13px;color:#555;margin-bottom:8px}
    @media (max-width:700px){ .form-row{flex-direction:column} .form-row label.small{width:100%} }
  </style>
</head>
<body>
  <div class="container">
    <nav class="nav">
      <a href="index.html">Inicio</a>
      <details><summary>Trabajo</summary><a href="ingreso.html">Ingreso de pedidos</a></details>
      <details><summary>Administración</summary><a href="cuentas.html">Alta de clientes</a></details>
    </nav>

    <div class="card">
      <h3>Alta / Edición de Cliente</h3>
      <div class="note">Completa los datos y presiona <strong>Guardar</strong>. El porcentaje debe ser un número entre 0 y 100.</div>

      <form id="form-cliente" autocomplete="off">
        <input type="hidden" id="clienteId" value="">
        <div class="form-row">
          <label class="small" for="nombre">Nombre:</label>
          <input id="nombre" name="nombre" class="input" placeholder="Razón social o nombre" required>
        </div>

        

        <div class="form-row">
          <label class="small" for="porcentaje">Porcentaje (%):</label>
          <input id="porcentaje" name="porcentaje" class="input" type="number" min="0" max="100" step="0.01" placeholder="Ej: 10.5">
        </div>

        <div class="form-row">
          <label class="small" for="comentarios">Comentarios:</label>
          <textarea id="comentarios" name="comentarios" class="input" placeholder="Observaciones internas (opcional)"></textarea>
        </div>

        <div style="margin-top:12px;display:flex;gap:8px">
          <button class="btn" type="submit" id="btnGuardar">Guardar</button>
          <button class="btn ghost" type="button" id="btnCancelar">Cancelar</button>
          <button class="btn ghost" type="button" id="btnExport">Exportar CSV</button>
        </div>
      </form>
    </div>

    <div class="card">
      <h3>Clientes registrados</h3>

      <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
        <div class="search-row">
          <input id="q" class="input" placeholder="Buscar por nombre..." style="min-width:240px">
          <button class="btn ghost" id="btnBuscar">Buscar</button>
          <button class="btn ghost" id="btnClear">Limpiar</button>
        </div>
        <div class="small" id="stats"></div>
      </div>

      <div id="listado" style="margin-top:12px"></div>
    </div>
  </div>

<script>
/* Alta Clientes - funcional sin backend (localStorage) */
(() => {
  const STORAGE_KEY = 'farmacia_clientes_v1';

  // Utils
  const $ = sel => document.querySelector(sel);
  const byId = id => document.getElementById(id);
  function loadClientes(){ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); }
  function saveClientes(list){ localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); }
  function genId(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }

  // CRUD
  function crearCliente(obj){
    const list = loadClientes();
    list.unshift(obj);
    saveClientes(list);
  }
  function actualizarCliente(id, changes){
    const list = loadClientes();
    const idx = list.findIndex(c => c.id === id);
    if(idx === -1) return false;
    list[idx] = {...list[idx], ...changes, updatedAt: new Date().toISOString()};
    saveClientes(list);
    return true;
  }
  function borrarCliente(id){
    let list = loadClientes();
    list = list.filter(c => c.id !== id);
    saveClientes(list);
  }

  // Validaciones
  function validarDatos({nombre, porcentaje}) {
    if(!nombre || nombre.trim() === '') return {ok:false,msg:'El nombre es obligatorio.'};
    if(porcentaje !== '' && porcentaje !== null && porcentaje !== undefined){
      const n = Number(porcentaje);
      if(Number.isNaN(n)) return {ok:false,msg:'El porcentaje debe ser un número.'};
      if(n < 0 || n > 100) return {ok:false,msg:'El porcentaje debe estar entre 0 y 100.'};
    }
    return {ok:true};
  }

  function existeNombreDuplicado(nombre, excludingId = null){
    const list = loadClientes();
    const low = nombre.trim().toLowerCase();
    return list.some(c => c.nombre.trim().toLowerCase() === low && c.id !== excludingId);
  }

  // Render listado
  function renderListado(filter = ''){
    const cont = byId('listado');
    const list = loadClientes();
    const filtered = filter.trim() === '' ? list : list.filter(c => c.nombre.toLowerCase().includes(filter.toLowerCase()));
    if(filtered.length === 0){
      cont.innerHTML = '<div class="small">No hay clientes registrados.</div>';
      byId('stats').textContent = `Total: ${list.length}`;
      return;
    }

    const rows = filtered.map(c => `
      <tr>
        <td style="width:8%">${c.id.slice(-6)}</td>
        <td style="width:35%"><strong>${escapeHtml(c.nombre)}</strong><div class="small">${escapeHtml(c.condicion||'')}</div></td>
        <td style="width:18%">${c.porcentaje !== '' && c.porcentaje !== null ? c.porcentaje + ' %' : '-'}</td>
        <td style="width:28%">${escapeHtml(c.comentarios||'')}</td>
        <td class="actions" style="width:11%">
          <button class="btn ghost" onclick="onEditar('${c.id}')">Editar</button>
          <button class="btn ghost" onclick="onEliminar('${c.id}')">Eliminar</button>
        </td>
      </tr>
    `).join('');

    cont.innerHTML = `
      <table>
        <thead><tr><th>ID</th><th>Nombre</th><th>Porcentaje</th><th>Comentarios</th><th>Acciones</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    `;
    byId('stats').textContent = `Mostrando ${filtered.length} / Total ${list.length}`;
  }

  // Helpers
  function escapeHtml(str = '') {
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
  }

  // Form handling
  const form = byId('form-cliente');
  const fldId = byId('clienteId');
  const fldNombre = byId('nombre');
  const fldCond = byId('condicion');
  const fldPorc = byId('porcentaje');
  const fldCom = byId('comentarios');
  const btnGuardar = byId('btnGuardar');
  const btnCancelar = byId('btnCancelar');

  form.addEventListener('submit', (e) => {
    e.preventDefault();
    const payload = {
      nombre: fldNombre.value.trim(),
      condicion: fldCond.value,
      porcentaje: fldPorc.value === '' ? '' : Number(fldPorc.value),
      comentarios: fldCom.value.trim()
    };

    const validation = validarDatos(payload);
    if(!validation.ok){ alert(validation.msg); return; }

    // Duplicate check
    if(existeNombreDuplicado(payload.nombre, fldId.value || null)){
      alert('Ya existe un cliente con el mismo nombre.');
      return;
    }

    if(fldId.value){
      // editar
      const ok = actualizarCliente(fldId.value, payload);
      if(ok){
        resetForm();
        renderListado(byId('q').value);
        alert('Cliente actualizado.');
      } else {
        alert('No se encontró el cliente para actualizar.');
      }
    } else {
      // crear
      const nuevo = {
        id: genId(),
        ...payload,
        createdAt: new Date().toISOString(),
        updatedAt: null
      };
      crearCliente(nuevo);
      resetForm();
      renderListado(byId('q').value);
      alert('Cliente creado correctamente.');
    }
  });

  btnCancelar.addEventListener('click', (e) => {
    e.preventDefault();
    resetForm();
  });

  function resetForm(){
    fldId.value = '';
    fldNombre.value = '';
    fldCond.value = '';
    fldPorc.value = '';
    fldCom.value = '';
    btnGuardar.textContent = 'Guardar';
  }

  // Global actions (exposed for inline onclick)
  window.onEditar = function(id){
    const list = loadClientes();
    const c = list.find(x => x.id === id);
    if(!c) { alert('Cliente no encontrado'); return; }
    fldId.value = c.id;
    fldNombre.value = c.nombre;
    fldCond.value = c.condicion || '';
    fldPorc.value = c.porcentaje === '' || c.porcentaje === null ? '' : c.porcentaje;
    fldCom.value = c.comentarios || '';
    btnGuardar.textContent = 'Actualizar';
    window.scrollTo({top:0,behavior:'smooth'});
  };

  window.onEliminar = function(id){
    if(!confirm('Confirma eliminar este cliente?')) return;
    borrarCliente(id);
    renderListado(byId('q').value);
  };

  // Search
  byId('btnBuscar').addEventListener('click', ()=> renderListado(byId('q').value));
  byId('q').addEventListener('keyup', (e)=> {
    if(e.key === 'Enter') renderListado(byId('q').value);
  });
  byId('btnClear').addEventListener('click', ()=> { byId('q').value=''; renderListado(''); });

  // Export CSV
  byId('btnExport').addEventListener('click', ()=> {
    const list = loadClientes();
    if(list.length === 0){ alert('No hay clientes para exportar.'); return; }
    const hdr = ['id','nombre','condicion','porcentaje','comentarios','createdAt','updatedAt'];
    const csv = [hdr.join(',')].concat(list.map(c => {
      return [
        `"${c.id}"`,
        `"${(c.nombre||'').replace(/"/g,'""')}"`,
        `"${(c.condicion||'').replace(/"/g,'""')}"`,
        `"${c.porcentaje===null||c.porcentaje===''? '': c.porcentaje}"`,
        `"${(c.comentarios||'').replace(/"/g,'""')}"`,
        `"${c.createdAt||''}"`,
        `"${c.updatedAt||''}"`
      ].join(',');
    })).join('\n');

    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'clientes_export.csv';
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  });

  // Seed sample data if none
  function seedSample(){
    const existing = loadClientes();
    if(existing.length === 0){
      const sample = [
        { id: genId(), nombre: 'Farmacia Central', condicion: 'Responsable Inscripto', porcentaje: 5, comentarios:'Cuenta mayorista', createdAt: new Date().toISOString(), updatedAt: null },
        { id: genId(), nombre: 'Distribuidora Norte', condicion: 'Monotributo', porcentaje: 8, comentarios:'Pago mensual', createdAt: new Date().toISOString(), updatedAt: null }
      ];
      saveClientes(sample);
    }
  }

  seedSample();
  renderListado();

})();
</script>
</body>
</html>
